# メモリ

## メモリの割り当て

```txt
Vertical bar `|` represents the chunk that has a Header
before: |-- prev -------|---- self ---------------
align:  |--------|-------|-------|-------|-------|
after:  |---------------||-------|----------------
```

この図はメモリ割り当てアルゴリズムにおける「チャンク（chunk）」の構造と整列（alignment）処理を視覚的に表現したものです。特に、チャンクのヘッダーとアライメントの関係、そしてメモリブロックの統合（coalescing）について示しています。

ヘッダー: 各チャンクの先頭に配置され、チャンクのサイズや使用状況（使用中か未使用か）などの情報を保持します。これにより、`free()` 関数が呼び出された際に、どのチャンクを解放すべきかを特定できます。

アライメント: メモリアクセスの効率性とハードウェアの要件を満たすために、メモリブロックは特定のバイト境界に整列されます。例えば、8バイトアライメントでは、各メモリブロックの開始アドレスが8の倍数になります。

## メモリ用語集

### Region (領域)

メモリ空間における連続したアドレス範囲のこと。例えば、あるプログラムが使用するために確保されたメモリの範囲を指します。

### Alignment (アライメント)

メモリ内のデータが特定の境界に配置されるように調整すること。例えば、4バイトのアライメントでは、データのアドレスが4の倍数になるように配置されます。これは、CPUがデータを効率的に読み書きするために重要です。

*   **理由**: CPUは、アライメントされたデータに対して最適化されたアクセスを提供します。アライメントされていないデータへのアクセスは、パフォーマンスの低下や、アーキテクチャによってはエラーを引き起こす可能性があります。
*   **例**:
    *   `align = 1`: 任意のアドレスに配置可能
    *   `align = 2`: アドレスは2の倍数
    *   `align = 4`: アドレスは4の倍数
*   **Layout**: Rustの`Layout`構造体では、サイズ(`size`)とアライメント(`align`)を指定してメモリのレイアウトを定義します。

### Header (ヘッダー)

メモリブロックの先頭に付加されるメタデータ。アロケータがメモリブロックを管理するために使用します。

*   **情報**: サイズ、アロケーションの状態（使用中かどうか）、次のヘッダーへのポインタなど。
*   **役割**:
    *   メモリブロックの追跡
    *   解放されたメモリブロックの再利用
    *   メモリのデフラグ

### Allocator (アロケータ)

メモリの割り当てと解放を管理するモジュール。

*   **種類**:
    *   `FirstFitAllocator`: 最初に見つかった利用可能な領域を使用するアロケータ。
*   **役割**:
    *   プログラムからのメモリ要求に応じて、適切なサイズのメモリブロックを提供する。
    *   不要になったメモリブロックを解放し、再利用できるようにする。
    *   メモリの断片化を最小限に抑える。

### Global Allocator (グローバルアロケータ)

プログラム全体で使用されるアロケータ。Rustでは、`#[global_allocator]`アトリビュートを使用して、カスタムアロケータを指定できます。

### メモリマップ

システム内の物理メモリの配置と属性を記述したテーブル。

*   **情報**:
    *   各メモリ領域の開始アドレス
    *   サイズ
    *   タイプ (例: 使用可能、予約済み、デバイスメモリ)
*   **役割**:
    *   OSがメモリを管理するために使用
    *   ブートローダーが初期メモリ配置を決定するために使用

### その他

*   **size**: 確保するメモリのサイズ（バイト単位）。
*   **ptr**: 確保されたメモリブロックへのポインタ。
*   **is\_allocated**: メモリブロックが現在割り当てられているかどうかを示すフラグ。
